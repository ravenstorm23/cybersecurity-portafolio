Durante este laboratorio se realizó el análisis estático de una muestra en formato **DOCX** utilizando Linux (Parrot OS), con el objetivo de identificar características relevantes del archivo y responder preguntas del reto.

---
# **Objetivo:**  
Analizar estáticamente un documento DOCX malicioso asociado a la vulnerabilidad CVE-2022-30190 (Follina), identificar su vector de ejecución, procesos involucrados y mapear su comportamiento a MITRE ATT&CK.




---

# Pregunta 1: Valor hash SHA1 de la muestra

Para garantizar la integridad del archivo y poder identificarlo de forma única, se calculó su **hash SHA1**.  
El hash permite verificar si la muestra ha sido modificada y compararla con bases de datos de malware.

**Comando utilizado:**

`sha1sum sample.docx`

Este comando genera el valor SHA1 del archivo analizado, el cual fue usado posteriormente en VirusTotal.

---
# Pregunta 2: Tipo de archivo completo según VirusTotal

Una vez obtenido el hash, la muestra fue analizada en **VirusTotal**, donde se identificó el tipo de archivo completo.

###  Análisis de la estructura interna del DOCX

Dado que los archivos `.docx` son contenedores ZIP, se inspeccionó su estructura interna para identificar los archivos que lo componen.

**Comando utilizado:**

`unzip -l sample.docx`

Este comando lista el contenido del archivo sin extraerlo, mostrando los distintos XML internos, entre ellos:

- `word/document.xml`
    
- `word/_rels/document.xml.rels`
    
- `docProps/*.xml`
    
- `[Content_Types].xml`
    

Este paso permitió entender cómo está organizado el documento internamente.
### Pregunta 4: Archivo XML que almacena la URL extraída

En documentos Word, los enlaces externos **no se almacenan directamente en el texto visible**, sino en archivos de **relaciones** (`.rels`), que definen vínculos a recursos externos.

Tras revisar la estructura del DOCX, se determinó que el archivo encargado de almacenar las URLs externas es:

`document.xml.rels`

Ubicado internamente en la ruta:

`word/_rels/document.xml.rels`

Este archivo contiene las referencias a URLs externas utilizadas por el documento, incluso cuando el Word se muestra en blanco al abrirse.

## Pregunta 5 : La URL extraída accede a un archivo HTML que activa la vulnerabilidad para ejecutar una carga maliciosa. Según las funciones de procesamiento HTML, cualquier archivo con menos de `<Number>` bytes no invocaría la carga útil.

La URL extraída desde el documento apunta a un archivo HTML externo que es procesado por Microsoft Word utilizando el **motor MSHTML** de Windows.

Este motor no procesa completamente archivos HTML de tamaño muy reducido. Según el comportamiento del motor de procesamiento HTML, el contenido se evalúa en **bloques de memoria de 4 KB**, por lo que cualquier archivo HTML con un tamaño **inferior a 4096 bytes** no es procesado completamente y **no activa la ejecución de la carga maliciosa**.

Por esta razón, el tamaño mínimo requerido para que el HTML invoque la vulnerabilidad es:

`4096 bytes`

Este valor depende del funcionamiento interno del motor HTML de Windows y no del contenido específico del documento Word.

### **Pregunta 6: Proceso que la muestra intenta terminar tras la ejecución**

Tras la ejecución del documento malicioso, la muestra intenta finalizar un proceso del sistema si este ya se encuentra en ejecución.

De acuerdo con el análisis del comportamiento asociado a las vulnerabilidades **CVE-2022-30190 (Follina)** y **CVE-2017-0199**, el documento explota el uso del protocolo `ms-msdt:` para invocar una herramienta legítima de Windows.

Esta herramienta corresponde al binario:

`msdt.exe`

(**Microsoft Support Diagnostic Tool**)

Durante el flujo del ataque, `msdt.exe` es utilizado como un **Living-off-the-Land Binary (LOLBin)** para ejecutar comandos de forma indirecta. Si el proceso ya se encuentra activo, la muestra intenta **terminarlo previamente** para evitar conflictos y asegurar la correcta ejecución de la carga maliciosa.

Este comportamiento es característico de exploits basados en Follina, donde `msdt.exe` actúa como el componente central para la ejecución del payload sin necesidad de macros.

Por esta razón, el proceso que la muestra intenta matar es:

`msdt.exe`

Nota:
Durante el análisis dinámico en VirusTotal no se observa explícitamente la ejecución del proceso `msdt.exe`. 
Esto se debe a limitaciones del entorno de ejecución de la sandbox, la cual no siempre muestra procesos secundarios 
cuando el exploit depende de delegación entre aplicaciones (LOLbins).

Sin embargo, el uso de `msdt.exe` se confirma a través de:
- El vector de ataque Follina (CVE-2022-30190)
- El uso del protocolo `ms-msdt:`
- Documentación pública y análisis previos del exploit

### **Pregunta 7: Regla de detección basada en Windows Event ID 4688**

Se solicitó definir una regla de detección basada en procesos utilizando **Windows Event ID 4688**, el cual registra la **creación de un nuevo proceso** en el sistema operativo Windows.

Este evento es ampliamente utilizado en **SIEM y análisis forense** para detectar ejecuciones anómalas y cadenas de ataque basadas en procesos padre-hijo.

---

### **Proceso y Proceso Padre Identificados**

- **ProcessName:**  
    `msdt.exe`
    
- **ParentProcessName:**  
    `WINWORD.EXE`
    

(Formato requerido: _Nombre del proceso, Nombre del proceso principal_)

---

### **Explicación del análisis**

Durante el análisis del comportamiento asociado a documentos maliciosos que explotan la vulnerabilidad **CVE-2022-30190 (Follina)**, se identifica una cadena de ejecución característica:

1. El usuario abre un documento malicioso en **Microsoft Word**.
    
2. El documento utiliza el protocolo `ms-msdt:` embebido en contenido HTML.
    
3. Este protocolo invoca la herramienta legítima de Windows **Microsoft Support Diagnostic Tool**.
    
4. Como resultado, el binario `msdt.exe` es ejecutado directamente por `WINWORD.EXE`.
    

Esta relación genera un evento **4688**, donde:

- El **nuevo proceso creado** es `msdt.exe`
    
- El **proceso padre** es `WINWORD.EXE`
    

---

### **Significado de Windows Event ID 4688 en este contexto**

El **Event ID 4688** indica que:

> “Un nuevo proceso ha sido creado en el sistema”

Esto permite detectar no solo **qué** proceso se ejecutó, sino también **quién lo ejecutó**, lo cual es clave para identificar abuso de binarios legítimos (**LOLbins**).

En un entorno normal, **Microsoft Word no debería lanzar `msdt.exe`**, por lo que esta relación padre-hijo es altamente sospechosa.

---

### **Aspectos clave a tener en cuenta para identificar estos procesos**

Al construir reglas de detección basadas en Event ID 4688, se deben considerar:

- La **relación padre-hijo** entre procesos.
    
- El **contexto de ejecución** del binario (no solo si es legítimo).
    
- El abuso de herramientas nativas de Windows como **msdt.exe**.
    
- La correlación con **documentos Office** como punto de entrada.
    
- Información OSINT sobre CVEs, TTPs y patrones de ataque conocidos.
    

---

### **Conclusión**

Basándose en el análisis del flujo de ejecución de la vulnerabilidad **Follina**, el evento 4688 relevante para detección muestra que:

- `WINWORD.EXE` crea el proceso `msdt.exe`
    
- Esta acción es indicativa de explotación activa
    

Por esta razón, los valores correctos para la regla de detección son:

`msdt.exe, WINWORD.EXE`


### **Pregunta 8: Técnica MITRE ATT&CK utilizada para la ejecución**

La muestra analizada explota una vulnerabilidad en Microsoft Word para iniciar la ejecución de código malicioso **sin utilizar macros**, apoyándose en componentes legítimos del sistema operativo Windows.

En el flujo del ataque asociado a **CVE-2022-30190 (Follina)**, el documento Word no ejecuta el payload de forma directa. En su lugar, utiliza el **protocolo `ms-msdt:`** para comunicarse con otro componente del sistema operativo y delegar la ejecución.

Este protocolo invoca la herramienta legítima de Windows:

`msdt.exe`  
(**Microsoft Support Diagnostic Tool**)

La ejecución del código ocurre cuando **Microsoft Word solicita a otro proceso del sistema que ejecute acciones en su nombre**, utilizando un **mecanismo de comunicación entre procesos** (Inter-Process Communication).

De acuerdo con el framework **MITRE ATT&CK**, este comportamiento corresponde a la técnica:

`T1559 – Inter-Process Communication`

Esta técnica describe escenarios en los que un proceso legítimo desencadena la ejecución de código mediante la interacción con otro proceso, utilizando mecanismos como:

- Protocol Handlers (por ejemplo, `ms-msdt:`)
    
- COM
    
- DDE
    
- RPC
    

En este caso específico, Word actúa como el **proceso iniciador**, mientras que `msdt.exe` es el **proceso ejecutor**, permitiendo la ejecución del payload sin necesidad de ejecutar código directamente desde el documento.

---

### **Dónde se consultó esta información**

La clasificación de la técnica se obtiene mediante **OSINT** y análisis de comportamiento en plataformas de sandbox y fuentes públicas, tales como:

- Documentación oficial de **MITRE ATT&CK – T1559 (Inter-Process Communication)**
    
- Análisis públicos de **CVE-2022-30190 (Follina)**
    
- Reportes de sandbox (VirusTotal, Hybrid Analysis, Any.Run), donde se observa:
    
    - Invocación del protocolo `ms-msdt:`
        
    - Creación del proceso `msdt.exe` desde `WINWORD.EXE`
        
    - Ejecución indirecta del payload
        

---

### **Qué tener en cuenta para identificar esta técnica en futuros análisis**

- Si un documento **no ejecuta código directamente**, pero:
    
    - Lanza otra herramienta del sistema
        
    - Utiliza protocolos especiales (`ms-msdt:`, `mshta:`, `file:`, etc.)
        
- Si se observa una relación **Parent → Child** entre procesos legítimos
    
- Si la ejecución ocurre mediante **delegación** y no ejecución directa
    

Entonces **no se trata solo de un exploit (T1203)**, sino de una técnica de **ejecución por comunicación entre procesos**, correspondiente a:

`T1559`

### **Pregunta 9: CVE asociado con la vulnerabilidad explotada**

La vulnerabilidad explotada por la muestra corresponde a:

`CVE-2022-30190`

Esta vulnerabilidad es conocida públicamente como **Follina** y afecta a **Microsoft Support Diagnostic Tool (MSDT)** cuando es invocado desde aplicaciones de Office, como Microsoft Word.

El exploit abusa del **protocolo `ms-msdt:`**, permitiendo que un documento Word ejecute código de forma remota **sin necesidad de macros** y **sin interacción significativa del usuario**, siempre que el archivo sea abierto.

En el flujo del ataque:

- El documento Word contiene una referencia externa a un recurso HTML.
    
- El HTML malicioso invoca el protocolo `ms-msdt:`.
    
- Windows interpreta este protocolo y lanza el binario legítimo:
    
    `msdt.exe`
    
- A través de este mecanismo, el atacante logra la **ejecución de comandos arbitrarios**.
    

---

### **Por qué esta CVE es la correcta**

Aunque en plataformas como VirusTotal pueden aparecer múltiples CVEs relacionadas (por ejemplo, **CVE-2017-0199**), el comportamiento observado en la muestra —uso de `ms-msdt:` y ejecución a través de `msdt.exe`— es **específico y característico** de:

`CVE-2022-30190 (Follina)`

CVE-2017-0199, en cambio, se basa en **HTA + mshta.exe**, lo cual **no coincide** con el flujo de ejecución observado en este análisis.

---

### **Dónde se valida esta información**

La asociación entre esta vulnerabilidad y el comportamiento observado se confirma mediante:

- Análisis OSINT de **CVE-2022-30190 (Follina)**
    
- Reportes técnicos de Microsoft
    
- Sandboxes (VirusTotal, Any.Run, Hybrid Analysis), donde se observa:
    
    - Invocación del protocolo `ms-msdt:`
        
    - Ejecución del proceso `msdt.exe` desde `WINWORD.EXE`

---
Este análisis se realizó únicamente con fines educativos y defensivos, en un entorno controlado de laboratorio.